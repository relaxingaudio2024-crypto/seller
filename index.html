<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS PRO - Secure Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { --mlbb: #8e44ad; --transfer: #27ae60; --dark: #1e272e; --bg: #f4f6f9; --primary: #3f51b5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 10px; margin: 0; }
        .container { max-width: 500px; margin: auto; }
        
        /* Dashboard Styling */
        .owner-section { background: var(--dark); color: white; padding: 20px; border-radius: 20px; margin-bottom: 15px; display: none; }
        .total-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
        .mini-card { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; text-align: center; font-size: 11px; }
        
        /* Status Buttons inside Dashboard */
        .status-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .status-btn { padding: 10px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; }

        /* Form Card */
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; position: relative; }
        .lock-overlay { display: none; background: rgba(255,255,255,0.95); position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; border-radius: 20px; align-items: center; justify-content: center; flex-direction: column; }
        
        label { font-size: 11px; font-weight: bold; color: var(--primary); margin-left: 5px; }
        select, input { width: 100%; padding: 12px; margin: 5px 0 12px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 14px; }
        .main-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }

        /* List UI */
        .list-item { background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); }
        .item-info b { font-size: 14px; color: #111; display: block; }
        .item-info small { color: #888; font-size: 11px; }
        .price-info { text-align: right; flex-grow: 1; margin-right: 15px; }
        .sale-amt { font-weight: bold; font-size: 15px; color: #111; }
        .profit-amt { font-size: 12px; font-weight: bold; color: #27ae60; margin-top: 2px; }
        .del-btn { color: #ff4757; cursor: pointer; background: none; border: none; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <button onclick="toggleOwnerDashboard()" style="width:100%; padding:10px; border-radius:10px; border:1px dashed var(--primary); background:none; color:var(--primary); font-weight:bold; margin-bottom:15px;">Admin Dashboard</button>

    <div id="ownerPanel" class="owner-section">
        <div style="display:flex; justify-content: space-between; align-items:center;">
            <h3 style="margin:0;">Insights</h3>
            <input type="date" id="viewDate" onchange="loadSales()" style="width:auto; padding:5px; border-radius:5px;">
        </div>
        
        <div style="text-align:center; margin:15px 0;">
            <small style="opacity:0.7">NET PROFIT (ALL)</small>
            <h1 id="allProfit" style="margin:0; color:#2ecc71;">0 K</h1>
        </div>

        <div class="total-grid">
            <div class="mini-card"><small>SALES</small><b id="totalSale">0</b></div>
            <div class="mini-card"><small>DIA PROFIT</small><b id="mlbbProfitDisp">0</b></div>
            <div class="mini-card" style="background:var(--transfer)"><small>MONEY PROFIT</small><b id="moneyProfitDisp">0</b></div>
        </div>

        <div class="status-controls">
            <button onclick="setLock(true)" class="status-btn" style="background:#ff4757;">üî¥ ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äï·Ä≠·Äê·Ä∫</button>
            <button onclick="setLock(false)" class="status-btn" style="background:#2e86de;">üîµ ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫</button>
        </div>
        
        <button onclick="copySummary()" style="width:100%; margin-top:15px; background:rgba(255,255,255,0.1); color:white; border:none; padding:12px; border-radius:10px; font-weight:bold;">Copy Detailed Summary</button>
    </div>

    <div class="card" id="formArea">
        <div id="lockOverlay" class="lock-overlay">
            <span class="material-icons" style="font-size:45px; color:#ff4757;">lock</span>
            <p style="font-weight:bold; color:#333;">·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äï·Ä≠·Äê·Ä∫·Äë·Ä¨·Ä∏·Äï·Ä´·Äû·Ää·Ä∫</p>
        </div>
        
        <div style="display:flex; gap:10px;">
            <div style="flex:1;"><label>SC RATE</label><input type="number" id="scRate" value="115" oninput="updateCost()"></div>
            <div style="flex:1;"><label>CATEGORY</label>
                <select id="mainType" onchange="toggleFields()">
                    <option value="MLBB">üíé MLBB</option>
                    <option value="Transfer">üí∏ Money</option>
                </select>
            </div>
        </div>

        <div id="mlbbGroup">
            <label>DIAMOND PACK</label>
            <select id="diaPack" onchange="updateCost()">
                <option value="0" data-sc="0">-- Pack --</option>
                <optgroup label="2X Diamonds">
                    <option value="50+50 Dia" data-sc="39">50+50 Dia</option>
                    <option value="150+150 Dia" data-sc="116.9">150+150 Dia</option>
                    <option value="250+250 Dia" data-sc="187.5">250+250 Dia</option>
                    <option value="500+500 Dia" data-sc="385">500+500 Dia</option>
                </optgroup>
                <optgroup label="Normal Diamonds">
                    <option value="86 Dia" data-sc="61.5">86 Dia</option>
                    <option value="172 Dia" data-sc="122">172 Dia</option>
                    <option value="257 Dia" data-sc="177.5">257 Dia</option>
                    <option value="343 Dia" data-sc="239">343 Dia</option>
                    <option value="429 Dia" data-sc="299.5">429 Dia</option>
                    <option value="514 Dia" data-sc="355">514 Dia</option>
                    <option value="600 Dia" data-sc="416.5">600 Dia</option>
                    <option value="706 Dia" data-sc="480">706 Dia</option>
                    <option value="878 Dia" data-sc="602">878 Dia</option>
                    <option value="1050 Dia" data-sc="724">1050 Dia</option>
                    <option value="2195 Dia" data-sc="1453">2195 Dia</option>
                    <option value="3688 Dia" data-sc="2424">3688 Dia</option>
                    <option value="5532 Dia" data-sc="3660">5532 Dia</option>
                    <option value="9288 Dia" data-sc="6079">9288 Dia</option>
                </optgroup>
                <optgroup label="Passes">
                    <option value="Weekly Pass" data-sc="76">Weekly Diamond Pass</option>
                    <option value="Twilight Pass" data-sc="402.5">Twilight Pass</option>
                </optgroup>
            </select>
            <label>PLAYER NAME / ID</label>
            <input type="text" id="playerId" placeholder="Customer name">
        </div>

        <div id="transferGroup" class="hidden">
            <label>BANK / WALLET</label>
            <select id="bankName">
                <option value="KPay">KPay</option><option value="WavePay">WavePay</option>
                <option value="KBZ Bank">KBZ Bank</option><option value="CB Bank/Pay">CB Bank/Pay</option>
                <option value="AYA Bank/Pay">AYA Bank/Pay</option><option value="Yoma Bank">Yoma Bank</option>
                <option value="uabpay">uabpay</option><option value="OK$">OK$</option><option value="Mytel Pay">Mytel Pay</option>
            </select>
            <label>ACTION</label>
            <select id="transferAction"><option value="·Äú·ÄΩ·Äæ·Ä≤">·Äú·ÄΩ·Äæ·Ä≤ (Out)</option><option value="·Äë·ÄØ·Äê·Ä∫">·Äë·ÄØ·Äê·Ä∫ (In)</option></select>
        </div>

        <div style="display:flex; gap:10px;">
            <div style="flex:1;"><label>·Ä°·Äõ·ÄÑ·Ä∫·Ä∏</label><input type="number" id="cost" placeholder="0"></div>
            <div style="flex:1;"><label>·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äà·Ä±·Ä∏</label><input type="number" id="sale" placeholder="0"></div>
        </div>
        <button onclick="saveData()" class="main-btn">SAVE TRANSACTION</button>
    </div>

    <span style="font-size:16px; font-weight:bold; margin:15px 5px; display:block;">·Äö·Äî·Ä±·Ä∑·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏</span>
    <div id="salesList"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAnpm1rcRiJKz1cHfzEEwyrHpeLDMu-pIw",
        authDomain: "new-pos-system-cd358.firebaseapp.com",
        projectId: "new-pos-system-cd358",
        storageBucket: "new-pos-system-cd358.firebasestorage.app",
        messagingSenderId: "850496462463",
        appId: "1:850496462463:web:dce467c5ae49792b3d694a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const OWNER_PIN = "515705";
    const todayStr = new Date().toLocaleDateString('en-CA');
    document.getElementById('viewDate').value = todayStr;

    function toggleFields() {
        const isMLBB = document.getElementById('mainType').value === 'MLBB';
        document.getElementById('mlbbGroup').classList.toggle('hidden', !isMLBB);
        document.getElementById('transferGroup').classList.toggle('hidden', isMLBB);
        updateCost();
    }

    function updateCost() {
        if(document.getElementById('mainType').value === 'MLBB') {
            const sc = parseFloat(document.getElementById('diaPack').selectedOptions[0].getAttribute('data-sc')) || 0;
            document.getElementById('cost').value = Math.round(sc * parseFloat(document.getElementById('scRate').value));
        }
    }

    async function saveData() {
        const sale = parseFloat(document.getElementById('sale').value) || 0;
        const cost = parseFloat(document.getElementById('cost').value) || 0;
        const type = document.getElementById('mainType').value;
        const uName = document.getElementById('playerId').value || "";
        const desc = (type === 'MLBB') ? document.getElementById('diaPack').value : document.getElementById('bankName').value + " " + document.getElementById('transferAction').value;
        if(sale === 0) return alert("·Äà·Ä±·Ä∏·Äî·Äæ·ÄØ·Äî·Ä∫·Ä∏·Äë·Ää·Ä∑·Ä∫·Äï·Ä´");
        await db.collection("sales").add({
            description: desc, userName: uName, cost, salePrice: sale, profit: sale - cost,
            type: type, dateKey: todayStr, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('sale').value = ""; document.getElementById('playerId').value = "";
    }

    let reportData = {}; 

    function loadSales() {
        const sDate = document.getElementById('viewDate').value;
        db.collection("sales").where("dateKey", "==", sDate).onSnapshot(snap => {
            let stats = { mlbbCnt: 0, mlbbProf: 0, moneyCnt: 0, moneyProf: 0, totalSale: 0 };
            let html = "";
            snap.forEach(doc => {
                const d = doc.data();
                stats.totalSale += d.salePrice;
                if(d.type === 'MLBB') { stats.mlbbCnt++; stats.mlbbProf += d.profit; }
                else { stats.moneyCnt++; stats.moneyProf += d.profit; }
                
                html += `
                <div class="list-item">
                    <div class="item-info">
                        <b>${d.description} ${d.userName ? '('+d.userName+')' : ''}</b>
                        <small>${d.timestamp ? d.timestamp.toDate().toLocaleTimeString() : 'Saving...'}</small>
                    </div>
                    <div class="price-info">
                        <span class="sale-amt">${d.salePrice.toLocaleString()} K</span>
                        <div class="profit-amt">+${d.profit.toLocaleString()} K</div>
                    </div>
                    <button class="del-btn" onclick="deleteRec('${doc.id}')"><span class="material-icons">delete</span></button>
                </div>`;
            });
            reportData = { ...stats, date: sDate };
            document.getElementById('allProfit').innerText = (stats.mlbbProf + stats.moneyProf).toLocaleString() + " K";
            document.getElementById('totalSale').innerText = stats.totalSale.toLocaleString();
            document.getElementById('mlbbProfitDisp').innerText = stats.mlbbProf.toLocaleString();
            document.getElementById('moneyProfitDisp').innerText = stats.moneyProf.toLocaleString();
            document.getElementById('salesList').innerHTML = html;
        });
    }

    function copySummary() {
        const totalProfit = reportData.mlbbProf + reportData.moneyProf;
        const text = `üìä Report (${reportData.date})\n\nüíé Diamonds: ${reportData.mlbbCnt} ·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏\n Profit: ${reportData.mlbbProf.toLocaleString()} K\n\nüí∏ Money: ${reportData.moneyCnt} ·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏\n Profit: ${reportData.moneyProf.toLocaleString()} K\n\nüí∞ Total Sale: ${reportData.totalSale.toLocaleString()} K\nüí∞ Net Profit: ${totalProfit.toLocaleString()} K`;
        navigator.clipboard.writeText(text);
        alert("·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·ÄÅ·Äª·ÄØ·Äï·Ä∫ Copy ·ÄÄ·Ä∞·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ");
    }

    function toggleOwnerDashboard() { if(prompt("Owner PIN:") === OWNER_PIN) document.getElementById('ownerPanel').style.display = 'block'; }
    
    // Lock Functionality (Syncs with Firebase to keep status across devices)
    async function setLock(isLocked) {
        document.getElementById('lockOverlay').style.display = isLocked ? 'flex' : 'none';
        localStorage.setItem('posLocked', isLocked);
    }
    
    if(localStorage.getItem('posLocked') === 'true') setLock(true);

    async function deleteRec(id) { if(prompt("Delete PIN:") === OWNER_PIN) await db.collection("sales").doc(id).delete(); }

    loadSales();
</script>
</body>
</html>